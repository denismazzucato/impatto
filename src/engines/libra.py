
from logging import debug
from pathlib import Path
import re
import subprocess
from src.abstract_domains.abstract_domain import AbstractDomain
from src.abstract_domains.disjunctive_poly import DisjunctivePoly
from src.abstract_domains.poly import Poly
from src.buckets import Bucket
from src.engines.base import TMP_DIR, Engine, read_engine_conf
from src.input_bounds import InputBounds, NetworkInputBounds
from src.program import NetworkProgram, Program
from src.utils.progress_bar import subprogress_bar


CONFIGURATION_TEMPLATE = """
	"generator": "diff_outcome",
	"network_path": "{}",
	"categoricals": [],
	"input_lowerbound": {},
	"input_upperbound": {}
"""

class LibraEngine:
  pass

class DisjunctiveCompletionEngine(Engine):
  def __init__(self, program: Program, input_bounds: InputBounds):
    assert(isinstance(program, NetworkProgram))
    assert(isinstance(input_bounds, NetworkInputBounds))

    self.program = program
    self.input_bounds = input_bounds
    self.variables = self.program.get_variables()

    TMP_DIR.mkdir(parents=True, exist_ok=True)
    configuration = "{" + CONFIGURATION_TEMPLATE.format(
      program.path.absolute(),
      input_bounds.lower_bound,
      input_bounds.upper_bound
    ) + "}"
    configuration_path = Path(TMP_DIR / 'network_configuration.json')
    configuration_path.write_text(configuration)
    self.configuration_path = configuration_path

    config = Path("./engines/disjunctive-completion.json")
    conf = read_engine_conf(config)
    self.engine_path = str(Path(conf['path']).absolute())
    self.args = conf["args"]
    self.command = ["python", self.engine_path] + self.args + [str(self.configuration_path.absolute())]
    self.str_command = ' '.join(self.command)

  @staticmethod
  def parse_disjunctive_completion_output(variables: list[str], output: str) -> AbstractDomain:
    """ Example output:
    Output composition (by testing): {0: 55871, 1: 44129} 

Bucket 0:
-1.0x 1.0y <= 0.0

Bucket 1:
1.0x -1.0y <= 0.0

Backward analysis (3 layers) for bucket 0 ...
 >> Affine Layer 0
 >> ReLU Layer 1: 1 infeasible polyhedra, created 16 out of 16 possibilities
 >> Affine Layer 1
 >> ReLU Layer 2: 133 infeasible polyhedra, created 109 out of 241 possibilities
 >> Affine Layer 2
End backward analysis for bucket 0 (with 7 polyhedra)

=== === 7 polyhedra
=== [1/7]
-0.2356564955456401x -0.3880718368746704y -0.04906849746852699z -0.08964583044836029w -0.09604505817335753p <= 0.6527982411143691
-0.04517623780014102x 0.07934722433373764y -0.04414914467789366z -0.010928030552676882w -0.050015640655962645p <= 0.18613450146808708
-0.32083505774817134x -0.4617111985350135y -0.08186143238059529z -0.11933662268514622w -0.14445733001690808p <= 0.1719327248550302
0.5026851201814111x 1.4857262850013058y -0.04400700595514806z 0.21800371592214773w 0.06963327555348542p <= 0.6929779095200264
-0.4431374258968229x -0.7297450233973608y -0.09227026656100212z -0.16857342487118374w -0.18060677576701617p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
0.13310325145721436x -0.7277261018753052y -0.24575990438461304z -0.07317644357681274w 0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [2/7]
-0.22488030744058565x -0.4469893559954345y -0.06896549419351z -0.09557027716329361w -0.05147366260561814p <= 0.6527982411143691
-0.02584757314758601x -0.026329937028322092y -0.07983730950398815z -0.021554389585066724w 0.02992965629195643p <= 0.18613450146808708
-0.2261831879999594x -0.9792089715268091y -0.25662526575413835z -0.17137357242334472w 0.2470323031117987p <= 0.1719327248550302
0.5594288754319408x 1.1754865924156732y -0.14877784898204993z 0.18680758690976518w 0.3043311424257311p <= 0.6929779095200264
-0.4228734724386466x -0.8405357643992177y -0.12968533501210222z -0.17971397952060983w -0.09679303044764803p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
-0.13310325145721436x 0.7277261018753052y 0.24575990438461304z 0.07317644357681274w -0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [3/7]
-0.21894242075261713x -0.33839254993402734y -0.04438077368996194z -0.07146994230190983w -0.06190405640544154p <= 0.6527982411143691
0.07597853480184558x 0.43945586252380586y -0.010169393154342288z 0.12082294115779901w 0.1974611330702465p <= 0.18613450146808708
-0.20740995175025567x -0.12457746801614y -0.050049586791951484z 0.00400864560801617w 0.08723044165785954p <= 0.1719327248550302
0.6382710175468702x 1.8887285919632788y -0.005979819707096823z 0.3654479588891242w 0.34658778359427345p <= 0.6929779095200264
-0.41170764475339283x -0.6363262051114775y -0.08345529269941243z -0.1343947943693705w -0.1164067391588885p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
0.25953638553619385x 0.7714206576347351y 0.07279103994369507z 0.28223544359207153w 0.5301419496536255p <= 0.0
0.13310325145721436x -0.7277261018753052y -0.24575990438461304z -0.07317644357681274w 0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [4/7]
-0.20816623264756268x -0.39731006905479144y -0.06427777041494495z -0.07739438901684315w -0.017332660837702164p <= 0.6527982411143691
0.09530719945440058x 0.3337787011617461y -0.04585755798043678z 0.11019658212540917w 0.27740643001816556p <= 0.18613450146808708
-0.11275808200204374x -0.6420752410079356y -0.22481342016549455z -0.04802830413018233w 0.4787200747865663p <= 0.1719327248550302
0.6950147727973999x 1.5784888993776462y -0.1107506627339987z 0.3342518298767416w 0.5812856504665191p <= 0.6929779095200264
-0.3914436912952165x -0.7471169461133345y -0.12087036115051253z -0.14553534901879658w -0.03259299383952036p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
0.25953638553619385x 0.7714206576347351y 0.07279103994369507z 0.28223544359207153w 0.5301419496536255p <= 0.0
-0.13310325145721436x 0.7277261018753052y 0.24575990438461304z 0.07317644357681274w -0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [5/7]
0.8369901673291777x 2.782221608407587y -0.14297214845359424z 0.3755379376604154w 0.05254080134150863p <= 2.1314981513571296
-0.04517623780014102x 0.07934722433373764y -0.04414914467789366z -0.010928030552676882w -0.050015640655962645p <= 0.18613450146808708
-0.32083505774817134x -0.4617111985350135y -0.08186143238059529z -0.11933662268514622w -0.14445733001690808p <= 0.1719327248550302
-0.5026851201814111x -1.4857262850013058y 0.04400700595514806z -0.21800371592214773w -0.06963327555348542p <= -0.6929779095200264
-0.4431374258968229x -0.7297450233973608y -0.09227026656100212z -0.16857342487118374w -0.18060677576701617p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
0.13310325145721436x -0.7277261018753052y -0.24575990438461304z -0.07317644357681274w 0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [6/7]
0.9688481166896687x 2.0613040467488735y -0.38643274518891924z 0.303046126334275w 0.5979185139800632p <= 2.1314981513571296
-0.02584757314758601x -0.026329937028322092y -0.07983730950398815z -0.021554389585066724w 0.02992965629195643p <= 0.18613450146808708
-0.2261831879999594x -0.9792089715268091y -0.25662526575413835z -0.17137357242334472w 0.2470323031117987p <= 0.1719327248550302
-0.5594288754319408x -1.1754865924156732y 0.14877784898204993z -0.18680758690976518w -0.3043311424257311p <= -0.6929779095200264
-0.4228734724386466x -0.8405357643992177y -0.12968533501210222z -0.17971397952060983w -0.09679303044764803p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
-0.13310325145721436x 0.7277261018753052y 0.24575990438461304z 0.07317644357681274w -0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [7/7]
0.0631255792046778x 0.7998670109580007y 0.2578032097612254z 0.12264487007992471w -0.3660273574087342p <= 0.43387110818697405
-0.02584757314758601x -0.026329937028322092y -0.07983730950398815z -0.021554389585066724w 0.02992965629195643p <= 0.18613450146808708
0.2261831879999594x 0.9792089715268091y 0.25662526575413835z 0.17137357242334472w -0.2470323031117987p <= -0.1719327248550302
0.5594288754319408x 1.1754865924156732y -0.14877784898204993z 0.18680758690976518w 0.3043311424257311p <= 0.6929779095200264
-0.4228734724386466x -0.8405357643992177y -0.12968533501210222z -0.17971397952060983w -0.09679303044764803p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
-0.13310325145721436x 0.7277261018753052y 0.24575990438461304z 0.07317644357681274w -0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== ===

Backward analysis (3 layers) for bucket 1 ...
 >> Affine Layer 0
 >> ReLU Layer 1: 9 infeasible polyhedra, created 8 out of 16 possibilities
 >> Affine Layer 1
 >> ReLU Layer 2: 100 infeasible polyhedra, created 22 out of 121 possibilities
 >> Affine Layer 2
End backward analysis for bucket 1 (with 4 polyhedra)

=== === 4 polyhedra
=== [1/4]
-0.5898603070605812x -1.0389276875601123y -0.107552910030631z -0.2271380178934127w -0.22651716635990693p <= -0.7074395814360552
-0.07520101605038931x -0.13245240741275666y -0.013711870449097496z -0.028957720200525117w -0.028878568127437276p <= 0.013120027495678865
-0.34036692596901474x -0.5994921493888796y -0.062061225222242555z -0.13106538615275198w -0.13070713636816222p <= 0.05938248792198397
-0.389260169639968x -0.6856083772081547y -0.07097623539448605z -0.14989274972149502w -0.14948303784503736p <= -0.03937913887425459
-0.4527273405801857x -0.7973938293764604y -0.0825486006550813z -0.17433210805109844w -0.1738555944422071p <= 0.20493332907586348
-0.09953834116458893x -0.7021595239639282y 0.10090585052967072z -0.05977214500308037w 0.07007376104593277p <= -0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
0.13310325145721436x -0.7277261018753052y -0.24575990438461304z -0.07317644357681274w 0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [2/4]
-0.7217182564210723x -0.3180101259013991y 0.135907686704694z -0.15464620656727232w -0.7718948789984615p <= -0.7074395814360552
-0.05587235139783431x -0.2381295687748164y -0.04940003527519199z -0.03958407923291496w 0.0510667288204818p <= 0.013120027495678865
-0.2457150562208028x -1.1169899223806752y -0.23682505859578562z -0.18310233589095049w 0.26078249676054455p <= 0.05938248792198397
-0.44600392489049767x -0.37536868462252215y 0.03379460763241582z -0.11869662070911247w -0.38418090471728306p <= -0.03937913887425459
-0.4324633871220094x -0.9081845703783173y -0.11996366910618139z -0.18547266270052454w -0.09004184912283897p <= 0.20493332907586348
-0.09953834116458893x -0.7021595239639282y 0.10090585052967072z -0.05977214500308037w 0.07007376104593277p <= -0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
-0.13310325145721436x 0.7277261018753052y 0.24575990438461304z 0.07317644357681274w -0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [3/4]
-0.8369901673291777x -2.782221608407587y 0.14297214845359424z -0.3755379376604154w -0.05254080134150863p <= -2.1314981513571296
-0.04517623780014102x 0.07934722433373764y -0.04414914467789366z -0.010928030552676882w -0.050015640655962645p <= 0.18613450146808708
-0.32083505774817134x -0.4617111985350135y -0.08186143238059529z -0.11933662268514622w -0.14445733001690808p <= 0.1719327248550302
-0.5026851201814111x -1.4857262850013058y 0.04400700595514806z -0.21800371592214773w -0.06963327555348542p <= -0.6929779095200264
-0.4431374258968229x -0.7297450233973608y -0.09227026656100212z -0.16857342487118374w -0.18060677576701617p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
0.13310325145721436x -0.7277261018753052y -0.24575990438461304z -0.07317644357681274w 0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== [4/4]
-0.9688481166896687x -2.0613040467488735y 0.38643274518891924z -0.303046126334275w -0.5979185139800632p <= -2.1314981513571296
-0.02584757314758601x -0.026329937028322092y -0.07983730950398815z -0.021554389585066724w 0.02992965629195643p <= 0.18613450146808708
-0.2261831879999594x -0.9792089715268091y -0.25662526575413835z -0.17137357242334472w 0.2470323031117987p <= 0.1719327248550302
-0.5594288754319408x -1.1754865924156732y 0.14877784898204993z -0.18680758690976518w -0.3043311424257311p <= -0.6929779095200264
-0.4228734724386466x -0.8405357643992177y -0.12968533501210222z -0.17971397952060983w -0.09679303044764803p <= 0.26019415500281484
0.09953834116458893x 0.7021595239639282y -0.10090585052967072z 0.05977214500308037w -0.07007376104593277p <= 0.5735787153244019
-0.25953638553619385x -0.7714206576347351y -0.07279103994369507z -0.28223544359207153w -0.5301419496536255p <= 0.0
-0.13310325145721436x 0.7277261018753052y 0.24575990438461304z 0.07317644357681274w -0.5505284070968628p <= 0.0
-0.6579763293266296x -1.1589012145996094y -0.11997292935848236z -0.25336751341819763w -0.25267496705055237p <= 0.11479455977678299
1.0x 0.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 1.0y 0.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 1.0z 0.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 1.0w 0.0p <= 1.0
0.0x 0.0y 0.0z 0.0w 1.0p <= 1.0
-1.0x -0.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -1.0y -0.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -1.0z -0.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -1.0w -0.0p <= 0.0
-0.0x -0.0y -0.0z -0.0w -1.0p <= 0.0
=== ===
    """
    # first, match all disjunctive polyhedra within two guards '=== ==='
    disjunctive_polyhedra = []
    matched_disjunction = re.findall(r'=== ===(.+?)\n=== ===', output, re.DOTALL)[0]
    
    matched_disjunction = matched_disjunction.split('===')[1:]
    str_disjunction = [
      ctx.split('\n')[1:-1]
      for ctx in matched_disjunction
    ]
    disjunction = [
      Poly.from_string_constraints(variables, lambda x: x, constraints)
      for constraints in subprogress_bar(str_disjunction, desc='Parsing disjunctive polyhedra')
    ]
    return DisjunctivePoly(disjunction).remove_bottoms()


  def run(self, bucket: Bucket) -> AbstractDomain:
    command = [self.command[0], "-Xfrozen_modules=off", "--"] + self.command[1:] + [str(bucket.id)]
    str_command = ' '.join(command)

    debug(f'Running command: {str_command}')
    process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    output, error = process.communicate()
    if error:
      raise Exception(f'Error running command: {str_command}\n\n{error}')
    else:
      debug('Command executed successfully')
    
    return DisjunctiveCompletionEngine.parse_disjunctive_completion_output(self.variables,output.decode('utf-8'))

  def get_variables(self) -> list[str]:
    return self.program.get_variables()